box: kiks/build-env

build:
  steps:
    - script:
      name: create build directory
      code: |
        mkdir -p build

    - script:
      name: initialize git submodules
      code: |
        git submodule update --init --recursive

    - script:
      name: static validations
      code: |
        ./tools/validate/format.sh

    - script:
      name: build
      code: |
        cd build
        cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Debug -DENABLE_SANITIZERS=ON -DENABLE_CODE_COVERAGE=ON
        ninja-build -v

    - script:
      name: unit test
      code: |
        cd build
        ctest --output-on-failure

  after-steps:
    - script:
      name: code coverage
      code: |
        cd build
        bash <(curl -s https://codecov.io/bash) -x ../tools/llvm-cov.sh

    - wantedly/pretty-slack-notify:
      webhook_url: $SLACK_WEBHOOK_URL
      notify_on: "failed"
